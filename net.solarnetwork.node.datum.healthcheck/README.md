# SolarNode Health Check Datum Source

This project provides SolarNode plugin that publishes various internal health check metrics
as a datum stream. This can be used to monitor the health of SolarNode components that support
health checks.

![settings](docs/solarnode-health-check-settings.png)

# Install

The plugin can be installed via the **Plugins** page on your SolarNode. It appears under the
**Datum** category as **Health Check Datum Source**.

# Use

Once installed, a new **Health Check** component will appear on the **Settings** page on your
SolarNode. Click on the **Manage** button to configure individual components. The source ID of the
generated datum stream can be _fixed_ or _dynamic_. Continue reading for more information.

## Fixed datum stream

In _fixed_ mode you must configure an explicit source ID value in the **Source ID** setting. Then a
single datum stream using that source ID will be generated, and a single `ok` status property will
be included with a value of either `true` (_all_ health checks passed) or `false` (_some_ health
check failed). Then for each included health check, another status property whose name is
`{checkId}_ok` will have either `true` or `false`. When `false` an additional `{checkId}_msg`
property will be included if the health check provided a reason for the failure.

For example, imagine two health checks are available, with Check ID values `thing1` and `thing2`.
You configure a **Source ID** value `health`. If all checks pass, a datum like the following would
be generated:

```json
{
  "sourceId"   : "health",
  "created"    : "2021-12-17 15:55:00Z",
  "ok"         : "true",
  "thing1_ok"  : "true",
  "thing2_ok"  : "true"
}
```

If `thing2` failed, a daum like the following would be generated:

```json
{
  "sourceId"   : "health",
  "created"    : "2021-12-17 15:55:00Z",
  "ok"         : "false",
  "thing1_ok"  : "true",
  "thing2_ok"  : "false",
  "thing2_msg" : "And this mess is so big and so deep and so tall, we cannot pick it up. There is no way at all!"
}
```

## Dynamic datum streams

If you _do not_ configure any **Source ID** value, then _dynamic_ source ID mode is enabled. In this
mode, _multiple_ datum streams are generated, one for _each_ health check. The source IDs are 
derived from the Check ID values, with certain reserved characters replaced and the length limited
to 64 characters. Each datum will have at most two properties: `ok` with either `true` or `false` 
representing the outcome of the check, and `msg` if the check failed and a reason was provided.

In the previous _fixed_ stream example where the `thing1` check passed and `thing2` failed, two
datum like the following would be generated:

```json
[
  {
    "sourceId" : "thing1",
    "created"  : "2021-12-17 15:55:00Z",
    "ok"       : "true",
  },
  {
    "sourceId" : "thing2",
    "created"  : "2021-12-17 15:55:00Z",
    "ok"       : "false",
    "msg"      : "And this mess is so big and so deep and so tall, we cannot pick it up. There is no way at all!"
  }
]
```

## Settings

Each device configuration contains the following overall settings:

| Setting              | Description |
|----------------------|-------------|
| Schedule             | A cron schedule that determines when data is collected. |
| Service Name         | A unique name to identify this data source with. |
| Service Group        | A group name to associate this data source with. |
| Source ID            | The SolarNetwork unique source ID to assign to datum generated by this component. |
| Publish Mode         | Controls when datum are published: `On change` for only when health status changes, `On failure` for only when a health check fails, or `Always` to publish full health check results regardless of their status. |
| Unchanged Max Secs   | When `On change` Publish Mode is configured, the maximum number of seconds to refrain from publishing un-changed datum, or `0` for no limit. |
| Check IDs            | An optional list of Health Check ID regular expressions to filter on. If not configured, all available health checks will be performed. |

### Settings notes

 * **Unchanged Max Secs** can be used to ensure that the datum stream does not have large gaps of
   datum over time, in case you want to have regular updates even when the health status is not
   changing.
